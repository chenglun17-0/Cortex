## 一、项目描述

**Cortex 智能研发项目管理系统**

采用前后端分离架构，核心特色为 **“Web 管理端 + CLI 开发端”** 的双端协同。

* **Web 前端**：交互体验类似于 Tower 和 Linear，提供敏捷看板与数据报表，用于项目进度的宏观监控。
* **CLI 终端**：专为技术人员设计，实现“开发即管理”。将工单状态流转与 Git 操作（分支创建、切换、合并）原子化绑定，消除上下文切换。

**核心 AI 能力（基于 LangChain + RAG）：**

1.  **工单智能聚合（事前辅助）**：
    * **语义查重**：在提单时，AI 实时计算新工单与历史工单的向量相似度，提示疑似重复问题，避免“重复造轮子”。
    * **解决方案推荐**：自动聚合历史相似工单的 PR 代码与解决文档，为开发者提供参考。

2.  **代码智能辅助（事后辅助）**：
    * **文档生成**：自动解析 Git Diff（代码变更），生成标准化的 Commit Message 与 Pull Request 描述。
    * **智能审查**：结合代码规范对提交代码进行自动化扫描与打分，辅助 Tech Lead 进行 Code Review。

## 二、技术选型

| 层级   | 模块       | 核心技术栈                       | 备注                    |
| ------ | ---------- | -------------------------------- | ----------------------- |
| 交互层 | Web前端    | React + Ant Design + React Query | 负责展示看板、报表      |
|        | CLI终端    | Python + Typer                   | 负责git自动化、状态流转 |
| 接入层 | API网关    | FastAPI                          |                         |
| 业务层 | 任务引擎   | Python                           |                         |
|        | Git桥接器  | GitPython + PyGithub/PyGitlab    | 操纵代码仓库            |
|        | AI引擎   | LangChain + OpenAI               | 语义查重、代码审查          |
| 数据层 | 关系型数据 | PostgreSQL + SQLModel + Alembic  | 存用户、工单状态        |
|        | 向量数据   | pgvector                         | 存任务特征、人员画像    |
|        | 缓存/队列  | Redis                            | 存JWT黑名单、Celery队列 |


### 核心自动化逻辑：

1.  **CLI 状态流转**：
    * `start <task_id>`：工单变更为“处理中”，本地自动切出规范分支（如 `feat/task-101`）。
    * `done <task_id>`：工单变更为“待审核”，自动推送代码，触发 AI 生成 PR 描述，并发起合并请求。

2.  **AI 介入流程**：
    * **提单时**：前端调用向量检索接口，返回 Top-K 相似历史工单。
    * **提交时**：后端接收 Git Diff，LLM 生成总结并进行代码规范检查，结果回写至 PR 评论区。
### 配置项：
**分支清理**：
    * 任务完成（Merged）后，CLI 自动识别并删除远程及本地的冗余分支。


## 完成情况
### 后端
✅ 已完成模块
1. 核心架构
FastAPI 框架集成：已建立完整的 API 框架
Tortoise ORM 集成：数据库 ORM 层已配置，支持自动建表
JWT 认证系统：完整的用户认证和授权机制
依赖注入系统：通过 deps.py 实现了当前用户获取
2. 用户管理
用户模型：完整的用户表结构，包含组织关联
用户注册：支持邮箱验证和密码哈希存储
用户认证：OAuth2 兼容的登录接口
3. 组织管理
组织模型：组织表结构已定义
组织 CRUD：基础的创建和查询功能
4. 项目管理
项目模型：包含组织关联、项目负责人、成员关系
项目创建：支持自动关联当前用户组织
项目查询：可查询当前用户参与的项目
5. 任务管理
任务模型：完整的任务表结构，关联项目和分配人
任务 CRUD：创建、查询、更新功能完整
任务状态管理：支持状态和优先级管理
分支管理：任务可关联 Git 分支名称
6. API 路由
统一 API 路由器：/api/v1/ 前缀的完整路由系统
模块化端点：按功能模块分离的路由文件


### CLI
#### auth
-  login    登录到 Cortex 系统并保存凭证
-  logout   注销登录 (删除本地凭证)
#### tasks
- list    列出分配给当前用户的任务
- start   开始任务:1. 检查/生成随机分支名并绑定到任务 2. 更新状态为 IN_PROGRESS 3. 切换 Git 分支
- pr      提交任务:1. 识别当前任务分支  2. 更新状态 -> REVIEW 3. Git Push 4. 打开 PR 链接
- done    完成任务 (远程已合并):1. 切换回 Main 分支并拉取最新代码 2. 更新任务状态 -> DONE 3. 根据配置决定是否删除本地功能分支
#### config
-  list   列出当前所有配置
- set    设置配置项.会自动尝试将 "true"/"false" 转为布尔值，数字转为 int.
#### worktree
- 集成 Git Worktree 功能，支持在独立目录中并行开发多个任务

  | 子命令 | 说明 |
  | ------ | ---- |
  | `create <branch> [-p/--path <path>]` | 为指定分支创建新的 worktree（默认路径 `.worktrees/<branch>`） |
  | `list` | 列出所有已创建的 worktree |
  | `remove <path> [-f/--force]` | 删除指定的 worktree（`-f` 强制删除未提交的更改） |
  | `prune` | 清理已失效的 worktree（分支已删除但目录仍在） |

  **使用场景**：当需要并行处理多个任务时，可为每个任务创建独立的 worktree，避免频繁切换分支。

### 前端

#### 登录页面
- 实现用户登录功能，支持输入用户名和密码进行身份验证。

#### 工作台页面
- **首页仪表盘** (`/`)
  - 用户欢迎信息
  - 待处理任务统计
  - 参与项目统计
  - 已完成任务统计
  - 我的任务列表（最近 5 条）
  - 最近项目列表

#### 个人中心页面
- **个人中心** (`/profile`)
  - 显示当前用户信息
  - 修改用户名
  - 修改密码（需提供旧密码）

#### 项目管理页面
- **项目列表页** (`/projects`)
  - 项目卡片展示（名称、描述、成员数）
  - 创建新项目（弹窗表单）
  - 编辑项目信息
  - 删除项目（检查未完成任务）
  - 快捷跳转到项目看板

- **项目看板页** (`/projects/:id`)
  - 类似 Tower/Linear 的敏捷看板视图
  - 四列布局：TODO、IN_PROGRESS、REVIEW、DONE
  - 拖拽任务卡片更新状态
  - 新建任务弹窗（标题、描述、优先级、截止日期）
  - 项目成员管理抽屉（添加/移除成员）
  - 实时同步任务状态到后端
  - 面包屑导航支持返回项目列表

#### 任务管理功能
- **任务列表页面** (`/tasks`)
  - 表格形式展示分配给当前用户的任务
  - 支持按状态、优先级筛选任务
  - 支持按标题/描述搜索任务
  - 显示任务 ID、标题、状态、优先级、所属项目
  - 支持跳转到任务详情和看板页面

- **任务详情页面** (`/tasks/:id`)
  - 展示任务完整信息：ID、标题、描述、状态、优先级、Git 分支名、创建/更新时间
  - 支持编辑任务属性（标题、描述、状态、优先级）
  - 支持跳转到所属项目的看板页面
  - 面包屑导航支持返回任务列表

- **全局看板页面** (`/board`)
  - 类似 Tower/Linear 的敏捷看板视图
  - 四列布局：待处理、进行中、待审核、已完成
  - 支持拖拽任务卡片在不同状态列之间流转
  - 支持按项目筛选任务
  - 点击任务卡片跳转到任务详情
  - 实时同步任务状态到后端

#### 导航与布局
- 侧边栏菜单：工作台、项目、任务、看板入口
- 面包屑导航支持多级页面跳转
- 用户信息显示与退出登录

---

## 三、未完成功能

### AI 能力（核心亮点功能）

| 功能 | 描述 | 依赖 |
|------|------|------|
| **语义查重** | 提单时 AI 实时计算向量相似度，提示疑似重复工单 | pgvector、OpenAI/LangChain |
| **解决方案推荐** | 自动聚合历史相似工单的 PR 代码与解决文档 | pgvector、OpenAI/LangChain |
| **文档生成** | 自动解析 Git Diff，生成标准化的 Commit Message 与 PR 描述 | OpenAI/LangChain |
| **智能审查** | 结合代码规范对提交代码进行自动化扫描与打分 | OpenAI/LangChain |

### 数据报表功能

| 功能 | 描述 |
|------|------|
| 数据报表页面 | 项目进度的宏观监控可视化（燃尽图、完成率统计等） |
| 统计 API | 后端提供任务完成率、工时统计等数据接口 |

### GitHub/GitLab 集成（部分实现）

| 功能 | 状态 |
|------|------|
| GitHub/GitLab Provider 框架 | 已实现 |
| 创建 PR/MR | 已实现 |
| **Git Diff 解析** | 未实现 |
| **AI 代码审查回写到 PR 评论区** | 未实现 |

### 基础设施

| 功能 | 描述 |
|------|------|
| pgvector 向量数据库 | 存储任务特征向量、人员画像 |
| Redis 缓存/JWT 黑名单 | Token 黑名单存储、Celery 结果缓存 |
| Celery 异步任务队列 | AI 处理异步执行 |
| 分支清理 Webhook 集成 | PR 合并后自动删除冗余分支 |

### 前端待实现

| 功能 | 描述 |
|------|------|
| 任务提单页面"相似工单"提示 | 提单时显示 AI 推荐的相似历史工单 |
| PR 审查状态展示 | 显示 AI 代码审查结果 |
| 数据报表/Analytics 页面 | 项目进度可视化统计 |

---

## 四、缺失依赖

以下为实现 AI 功能需要添加的依赖：

```toml
# pyproject.toml 待添加
langchain = "^0.2.0"
langchain-openai = "^0.1.0"
openai = "^1.0.0"
pgvector = "^0.3.0"
celery = "^5.4.0"
redis = "^5.0.0"
```

### 待补充的环境变量

```bash
# .env 待配置
OPENAI_API_KEY=""          # OpenAI API Key
DATABASE_URL=""            # PostgreSQL + pgvector 连接字符串
REDIS_URL=""               # Redis 连接字符串
GITHUB_TOKEN=""            # GitHub Personal Access Token（可选）
GITLAB_TOKEN=""            # GitLab Personal Access Token（可选）
```